<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>슈퍼관리자 | inCLASS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans KR', sans-serif; }

        body {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dark-glass {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-pending {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .status-approved {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .status-rejected {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .request-card {
            transition: all 0.3s ease;
        }

        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .image-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90vh;
            border-radius: 16px;
        }

        .tab-btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #0ea5e9;
            font-weight: 700;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: #0ea5e9;
            border-radius: 2px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .request-item {
            animation: slideIn 0.3s ease-out;
        }

        /* 반응형 */
        @media (min-width: 768px) {
            .request-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .request-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 헤더 -->
    <header class="dark-glass sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
                        <span class="material-symbols-outlined text-white">shield</span>
                    </div>
                    <div>
                        <h1 class="text-white font-bold text-lg">슈퍼관리자</h1>
                        <p class="text-gray-400 text-xs">inCLASS Admin</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-gray-400">notifications</span>
                    <button onclick="window.location.href='index.html'" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                        <span class="material-symbols-outlined text-gray-400">home</span>
                    </button>
                </div>
            </div>

            <!-- 탭 -->
            <div class="flex gap-6 mt-4 border-b border-white/10">
                <button class="tab-btn active py-3 text-sm" onclick="switchTab('admin')">
                    관리자 신청 <span id="admin-count" class="ml-1 px-2 py-0.5 bg-amber-500 text-white text-xs rounded-full">0</span>
                </button>
                <button class="tab-btn py-3 text-gray-400 text-sm" onclick="switchTab('student')">
                    학부모 신청 <span id="student-count" class="ml-1 px-2 py-0.5 bg-amber-500 text-white text-xs rounded-full">0</span>
                </button>
                <button class="tab-btn py-3 text-gray-400 text-sm" onclick="switchTab('approved')">
                    승인 완료
                </button>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- 관리자 신청 탭 -->
        <div id="admin-tab" class="tab-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-white font-semibold">관리자 가입 신청</h2>
                <button onclick="loadAdminRequests()" class="text-sky-400 text-sm flex items-center gap-1 hover:text-sky-300">
                    <span class="material-symbols-outlined text-sm">refresh</span>
                    새로고침
                </button>
            </div>
            <div id="admin-requests" class="request-grid space-y-4 md:space-y-0">
                <!-- 요청 카드가 여기에 추가됨 -->
            </div>
        </div>

        <!-- 학부모 신청 탭 -->
        <div id="student-tab" class="tab-content hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-white font-semibold">학부모 가입 신청</h2>
                <button onclick="loadStudentRequests()" class="text-sky-400 text-sm flex items-center gap-1 hover:text-sky-300">
                    <span class="material-symbols-outlined text-sm">refresh</span>
                    새로고침
                </button>
            </div>
            <div id="student-requests" class="request-grid space-y-4 md:space-y-0">
                <!-- 요청 카드가 여기에 추가됨 -->
            </div>
        </div>

        <!-- 승인 완료 탭 -->
        <div id="approved-tab" class="tab-content hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-white font-semibold">승인 완료 목록</h2>
                <button onclick="loadApprovedList()" class="text-sky-400 text-sm flex items-center gap-1 hover:text-sky-300">
                    <span class="material-symbols-outlined text-sm">refresh</span>
                    새로고침
                </button>
            </div>
            <div id="approved-list" class="request-grid space-y-4 md:space-y-0">
                <!-- 승인 완료 카드가 여기에 추가됨 -->
            </div>
        </div>
    </main>

    <!-- 이미지 모달 -->
    <div id="image-modal" class="image-modal" onclick="closeImageModal()">
        <img id="modal-image" src="" alt="사업자등록증">
        <button class="absolute top-4 right-4 text-white text-4xl">&times;</button>
    </div>

    <!-- 거절 사유 모달 -->
    <div id="reject-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-2xl p-6 w-full max-w-md" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-gray-800 mb-4">거절 사유 입력</h3>
            <textarea id="reject-reason" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-sky-500 focus:outline-none resize-none" rows="4" placeholder="거절 사유를 입력해주세요..."></textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="closeRejectModal()" class="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-600 hover:bg-gray-50">취소</button>
                <button onclick="confirmReject()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">거절</button>
            </div>
        </div>
    </div>

    <!-- 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="auth.js"></script>
    <script>
        let currentTab = 'admin';
        let selectedRequestId = null;

        // 페이지 로드 시
        document.addEventListener('DOMContentLoaded', async () => {
            // 슈퍼관리자 권한 확인
            await checkSuperAdmin();

            // 요청 목록 로드
            loadAdminRequests();
            loadStudentRequests();
            loadApprovedList();
        });

        // 슈퍼관리자 권한 확인
        async function checkSuperAdmin() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('로그인이 필요합니다.');
                    window.location.href = 'index.html';
                    return;
                }

                // bhy312@gmail.com은 항상 슈퍼관리자
                if (user.email === 'bhy312@gmail.com') {
                    return; // 슈퍼관리자 접속 허용
                }

                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('is_super_admin')
                    .eq('id', user.id)
                    .single();

                if (error || !profile?.is_super_admin) {
                    alert('슈퍼관리자 권한이 필요합니다.');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('권한 확인 에러:', error);
                alert('권한 확인 중 오류가 발생했습니다.');
                window.location.href = 'index.html';
            }
        }

        // 탭 전환
        function switchTab(tab) {
            currentTab = tab;

            // 탭 버튼 스타일
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-400');
            });
            event.target.classList.add('active');
            event.target.classList.remove('text-gray-400');

            // 컨텐츠 표시
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tab}-tab`).classList.remove('hidden');

            // 데이터 로드
            if (tab === 'admin') loadAdminRequests();
            else if (tab === 'student') loadStudentRequests();
            else loadApprovedList();
        }

        // 관리자 요청 목록 로드
        async function loadAdminRequests() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('role', 'admin')
                    .eq('approval_status', 'pending')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('admin-requests');
                document.getElementById('admin-count').textContent = data?.length || 0;

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-gray-600">inbox</span>
                            <p class="text-gray-400 mt-4">대기 중인 신청이 없습니다</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.map(req => createAdminCard(req)).join('');
            } catch (error) {
                console.error('관리자 요청 로드 에러:', error);
            }
        }

        // 학부모 요청 목록 로드
        async function loadStudentRequests() {
            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('*, profiles!parent_id(name, email)')
                    .eq('approval_status', 'pending')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('student-requests');
                document.getElementById('student-count').textContent = data?.length || 0;

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-gray-600">inbox</span>
                            <p class="text-gray-400 mt-4">대기 중인 신청이 없습니다</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.map(req => createStudentCard(req)).join('');
            } catch (error) {
                console.error('학부모 요청 로드 에러:', error);
            }
        }

        // 승인 완료 목록 로드
        async function loadApprovedList() {
            try {
                const { data: admins, error: adminError } = await supabase
                    .from('profiles')
                    .select('*')
                    .in('role', ['Admin', 'admin'])
                    .eq('approval_status', 'approved')
                    .order('created_at', { ascending: false })
                    .limit(50);

                const container = document.getElementById('approved-list');

                if (!admins || admins.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-gray-600">inbox</span>
                            <p class="text-gray-400 mt-4">승인 완료된 관리자가 없습니다</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = admins.map(admin => createApprovedCard(admin)).join('');
            } catch (error) {
                console.error('승인 완료 목록 로드 에러:', error);
            }
        }

        // 관리자 카드 생성
        function createAdminCard(req) {
            return `
                <div class="request-item glass-card rounded-2xl p-5 request-card">
                    <div class="flex items-start justify-between mb-4">
                        <span class="status-pending text-white text-xs px-3 py-1 rounded-full font-semibold">대기중</span>
                        <span class="text-gray-400 text-xs">${new Date(req.created_at).toLocaleDateString('ko-KR')}</span>
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg mb-3">${req.academy_name || '-'}</h3>
                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">person</span>
                            <span>대표자: ${req.name || '-'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">phone</span>
                            <span>${req.full_phone || '-'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">confirmation_number</span>
                            <span>${req.business_number || '-'}</span>
                        </div>
                    </div>
                    ${req.business_license_url ? `
                        <div class="mb-4">
                            <img src="${req.business_license_url}" alt="사업자등록증" class="w-full h-32 object-cover rounded-xl cursor-pointer hover:opacity-90" onclick="openImageModal('${req.business_license_url}')">
                        </div>
                    ` : ''}
                    <div class="flex gap-2">
                        <button onclick="openTaxSearch('${req.business_number}')" class="flex-1 py-2 border-2 border-sky-200 text-sky-600 rounded-lg font-semibold text-sm hover:bg-sky-50">
                            <span class="material-symbols-outlined text-sm align-middle">search</span>
                            국세청 확인
                        </button>
                        <button onclick="showRejectModal('${req.id}', 'admin')" class="flex-1 py-2 border-2 border-red-200 text-red-500 rounded-lg font-semibold text-sm hover:bg-red-50">
                            <span class="material-symbols-outlined text-sm align-middle">close</span>
                            거절
                        </button>
                        <button onclick="approveAdmin('${req.id}')" class="flex-1 py-2 bg-sky-500 text-white rounded-lg font-semibold text-sm hover:bg-sky-600">
                            <span class="material-symbols-outlined text-sm align-middle">check</span>
                            승인
                        </button>
                    </div>
                </div>
            `;
        }

        // 학부모 카드 생성
        function createStudentCard(req) {
            return `
                <div class="request-item glass-card rounded-2xl p-5 request-card">
                    <div class="flex items-start justify-between mb-4">
                        <span class="status-pending text-white text-xs px-3 py-1 rounded-full font-semibold">대기중</span>
                        <span class="text-gray-400 text-xs">${new Date(req.created_at).toLocaleDateString('ko-KR')}</span>
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg mb-3">${req.name || '-'}</h3>
                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">school</span>
                            <span>${req.school_name || '-'} ${req.grade ? req.grade + '학년' : ''}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">cake</span>
                            <span>${req.birth_date ? new Date(req.birth_date).toLocaleDateString('ko-KR') : '-'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">phone</span>
                            <span>${req.full_phone || '-'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">family_restroom</span>
                            <span>학부모: ${req.profiles?.name || '-'}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showRejectModal('${req.id}', 'student')" class="flex-1 py-2 border-2 border-red-200 text-red-500 rounded-lg font-semibold text-sm hover:bg-red-50">
                            <span class="material-symbols-outlined text-sm align-middle">close</span>
                            거절
                        </button>
                        <button onclick="approveStudent('${req.id}')" class="flex-1 py-2 bg-sky-500 text-white rounded-lg font-semibold text-sm hover:bg-sky-600">
                            <span class="material-symbols-outlined text-sm align-middle">check</span>
                            승인
                        </button>
                    </div>
                </div>
            `;
        }

        // 승인 완료 카드 생성
        function createApprovedCard(admin) {
            return `
                <div class="glass-card rounded-2xl p-5 request-card">
                    <div class="flex items-start justify-between mb-4">
                        <span class="status-approved text-white text-xs px-3 py-1 rounded-full font-semibold">승인완료</span>
                        <span class="text-gray-400 text-xs">${new Date(admin.created_at).toLocaleDateString('ko-KR')}</span>
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg mb-3">${admin.academy_name || '-'}</h3>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">person</span>
                            <span>대표자: ${admin.name || '-'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">phone</span>
                            <span>${admin.full_phone || '-'}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">email</span>
                            <span>${admin.email || '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // 관리자 승인
        async function approveAdmin(adminId) {
            if (!confirm('이 관리자를 승인하시겠습니까?')) return;

            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ approval_status: 'approved' })
                    .eq('id', adminId);

                if (error) throw error;

                // 알림 읽음 처리
                await supabase
                    .from('admin_registration_notifications')
                    .update({ is_read: true })
                    .eq('admin_id', adminId);

                showToast('승인이 완료되었습니다.', 'success');
                loadAdminRequests();
                loadApprovedList();
            } catch (error) {
                console.error('승인 에러:', error);
                showToast('승인에 실패했습니다.', 'error');
            }
        }

        // 학부모 승인
        async function approveStudent(studentId) {
            if (!confirm('이 학부모를 승인하시겠습니까?')) return;

            try {
                const { error } = await supabase
                    .from('students')
                    .update({ approval_status: 'approved' })
                    .eq('id', studentId);

                if (error) throw error;

                // 알림 읽음 처리
                await supabase
                    .from('parent_registration_notifications')
                    .update({ is_read: true })
                    .eq('student_id', studentId);

                showToast('승인이 완료되었습니다.', 'success');
                loadStudentRequests();
            } catch (error) {
                console.error('승인 에러:', error);
                showToast('승인에 실패했습니다.', 'error');
            }
        }

        // 거절 모달 표시
        function showRejectModal(id, type) {
            selectedRequestId = { id, type };
            document.getElementById('reject-modal').classList.remove('hidden');
            document.getElementById('reject-reason').value = '';
            document.getElementById('reject-reason').focus();
        }

        // 거절 모달 닫기
        function closeRejectModal() {
            document.getElementById('reject-modal').classList.add('hidden');
            selectedRequestId = null;
        }

        // 거절 확인
        async function confirmReject() {
            const reason = document.getElementById('reject-reason').value.trim();
            if (!reason) {
                alert('거절 사유를 입력해주세요.');
                return;
            }

            if (!selectedRequestId) return;

            try {
                const { id, type } = selectedRequestId;
                const table = type === 'admin' ? 'profiles' : 'students';

                const { error } = await supabase
                    .from(table)
                    .update({ approval_status: 'rejected', rejection_reason: reason })
                    .eq('id', id);

                if (error) throw error;

                showToast('거절 처리가 완료되었습니다.', 'success');
                closeRejectModal();

                if (type === 'admin') loadAdminRequests();
                else loadStudentRequests();
            } catch (error) {
                console.error('거절 에러:', error);
                showToast('거절에 실패했습니다.', 'error');
            }
        }

        // 이미지 모달 열기
        function openImageModal(url) {
            document.getElementById('modal-image').src = url;
            document.getElementById('image-modal').classList.add('show');
        }

        // 이미지 모달 닫기
        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('show');
        }

        // 국세청 사업자등록 조회
        function openTaxSearch(businessNumber) {
            const cleanNumber = businessNumber.replace(/[^0-9]/g, '');
            window.open(`https://hometax.go.kr/websquare/websquare.html?w2xPath=/ui/pp/index_pp.xml&tmIdx=47&tm2lIdx=4712080000&tm3lIdx=4712080100&bn=${cleanNumber}`, '_blank');
        }

        // 토스트 메시지
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 ${
                type === 'success' ? 'bg-emerald-500' : 'bg-red-500'
            } text-white font-semibold`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
