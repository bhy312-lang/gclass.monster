<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정보 등록 - 스터디룸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 50%, #e8eaf6 100%);
            min-height: 100vh;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-pink-400 to-purple-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                <span class="material-symbols-outlined text-white text-3xl">person_add</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">정보 등록</h1>
            <p class="text-gray-500 mt-2">연락처와 자녀 정보를 등록해주세요</p>
        </div>

        <!-- 등록 폼 -->
        <form id="registerForm" class="space-y-6">
            <!-- 이름 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-lg">badge</span>
                        이름 (학부모)
                    </span>
                </label>
                <input type="text" id="parentName" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:ring-0 outline-none transition-colors"
                    placeholder="홍길동">
            </div>

            <!-- 전화번호 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-lg">phone</span>
                        휴대폰 번호
                    </span>
                </label>
                <input type="tel" id="phoneNumber" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:ring-0 outline-none transition-colors"
                    placeholder="010-1234-5678"
                    oninput="formatPhoneNumber(this)">
                <p class="text-xs text-gray-400 mt-1">* 키오스크에서 뒷자리 4자리로 등원 처리합니다</p>
            </div>

            <!-- 자녀 목록 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-lg">child_care</span>
                        자녀 이름
                    </span>
                </label>
                <div id="childrenList" class="space-y-2 mb-2">
                    <!-- 자녀 입력 필드가 동적으로 추가됨 -->
                </div>
                <button type="button" onclick="addChildField()"
                    class="w-full flex items-center justify-center gap-1 text-pink-500 hover:text-pink-600 py-2 border-2 border-dashed border-pink-200 hover:border-pink-300 rounded-xl transition-colors">
                    <span class="material-symbols-outlined text-lg">add</span>
                    <span>자녀 추가</span>
                </button>
            </div>

            <!-- 제출 버튼 -->
            <button type="submit"
                class="w-full bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl">
                등록 완료
            </button>
        </form>

        <!-- 로그아웃 -->
        <button onclick="handleLogout()"
            class="w-full mt-4 text-gray-400 hover:text-gray-600 text-sm transition-colors">
            다른 계정으로 로그인
        </button>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="auth.js"></script>

    <script>
        let currentUser = null;
        let childCount = 0;

        // URL에서 redirect 파라미터 추출
        function getRedirectUrl(defaultUrl = 'index.html') {
            const params = new URLSearchParams(window.location.search);
            const redirect = params.get('redirect');
            // 외부 URL 방지: 같은 도메인인지 확인
            if (redirect) {
                try {
                    const url = new URL(redirect, window.location.origin);
                    if (url.origin === window.location.origin) {
                        return redirect;
                    }
                } catch (e) {
                    // 무효한 URL이면 기본값 사용
                }
            }
            return defaultUrl;
        }

        // 페이지 로드 시 인증 확인
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();

            if (!session?.user) {
                // redirect URL 유지하며 로그인 페이지로 이동
                const currentParams = window.location.search;
                window.location.href = `login.html${currentParams}`;
                return;
            }

            currentUser = session.user;

            // 기존 프로필 정보 로드
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (profile) {
                if (profile.name) document.getElementById('parentName').value = profile.name;
                if (profile.phone) document.getElementById('phoneNumber').value = profile.phone;
            }

            // 기존 자녀 목록 로드
            const { data: students } = await supabase
                .from('students')
                .select('*')
                .eq('parent_id', currentUser.id);

            if (students && students.length > 0) {
                students.forEach(student => addChildField(student.name, student.id));
            } else {
                // 기본 1개 입력 필드 추가
                addChildField();
            }
        }

        // 전화번호 자동 포맷
        function formatPhoneNumber(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 3 && value.length <= 7) {
                value = value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length > 7) {
                value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
            input.value = value;
        }

        // 자녀 입력 필드 추가
        function addChildField(name = '', studentId = null) {
            childCount++;
            const container = document.getElementById('childrenList');

            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'flex gap-2 items-center';
            fieldDiv.id = `child-${childCount}`;
            fieldDiv.dataset.studentId = studentId || '';

            fieldDiv.innerHTML = `
                <input type="text" name="childName" value="${name}" required
                    class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-400 focus:ring-0 outline-none transition-colors"
                    placeholder="자녀 이름">
                <button type="button" onclick="removeChildField(${childCount})"
                    class="p-2 text-gray-400 hover:text-red-500 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            `;

            container.appendChild(fieldDiv);
        }

        // 자녀 입력 필드 제거
        function removeChildField(id) {
            const field = document.getElementById(`child-${id}`);
            if (field && document.querySelectorAll('#childrenList > div').length > 1) {
                field.remove();
            }
        }

        // 폼 제출
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('parentName').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();
            const phoneDigits = phone.replace(/[^0-9]/g, '');

            if (phoneDigits.length < 10) {
                alert('올바른 전화번호를 입력해주세요.');
                return;
            }

            // 자녀 이름 수집
            const childInputs = document.querySelectorAll('input[name="childName"]');
            const children = [];
            childInputs.forEach((input, index) => {
                const childName = input.value.trim();
                const parentDiv = input.closest('div[id^="child-"]');
                const studentId = parentDiv?.dataset?.studentId || null;
                if (childName) {
                    children.push({ name: childName, id: studentId });
                }
            });

            if (children.length === 0) {
                alert('최소 1명의 자녀를 등록해주세요.');
                return;
            }

            try {
                // 프로필 업데이트
                const { error: profileError } = await supabase
                    .from('profiles')
                    .update({
                        name: name,
                        phone: phone,
                        phone_last4: phoneDigits.slice(-4)
                    })
                    .eq('id', currentUser.id);

                if (profileError) throw profileError;

                // 기존 자녀 삭제 (ID가 없는 것들)
                const existingIds = children.filter(c => c.id).map(c => c.id);

                // 새 자녀 추가 또는 업데이트
                for (const child of children) {
                    if (child.id) {
                        // 기존 자녀 업데이트
                        await supabase
                            .from('students')
                            .update({
                                name: child.name,
                                parent_phone_last4: phoneDigits.slice(-4)
                            })
                            .eq('id', child.id);
                    } else {
                        // 새 자녀 추가
                        await supabase
                            .from('students')
                            .insert({
                                name: child.name,
                                parent_id: currentUser.id,
                                parent_phone_last4: phoneDigits.slice(-4)
                            });
                    }
                }

                alert('등록이 완료되었습니다!');
                // redirect URL로 이동 (없으면 index.html)
                const redirectUrl = getRedirectUrl('index.html');
                window.location.href = redirectUrl;

            } catch (error) {
                console.error('등록 실패:', error);
                alert('등록에 실패했습니다: ' + error.message);
            }
        });

        // 로그아웃
        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
